{% extends "layout.html" %}

{% block title %}
    เพิ่มร้านอาหารใหม่
{% endblock %}

{% block content %}
<h1 class="text-center text-2xl font-bold mb-4">เพิ่มร้านอาหารใหม่</h1>

<div class="flex justify-center">
    <form method="post" class="w-full max-w-lg">
        
    
        {% csrf_token %}
        <h1 class="text-left text-sm font-bold mb-4 mt-9">ข้อมูลพื้นฐาน</h1>
        <div class="bg-white p-6 rounded shadow-md my-5">
            <div class="mb-4">
                <label for="name" class="block text-sm font-medium text-gray-700">ชื่อร้าน</label>
                <input required type="text" name="name" id="name" value="{{ form.name.value|default:'' }}" class="font-highlight w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
        
            <div class="mb-4">
                <label for="service_type" class="block text-sm font-medium text-gray-700">รูปแบบบริการ</label>
                <select name="service_type" class="font-highlight w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    {% for choice in form.service_type.field.choices %}
                        <option value="{{ choice.0 }}" {% if form.service_type.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                    {% endfor %}
                </select>
            </div>
        
            <div class="mb-4">
                <label for="price_range" class="block text-sm font-medium text-gray-700">ช่วงราคา</label>
                <select name="price_range" class="font-highlight w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    {% for choice in form.price_range.field.choices %}
                        <option value="{{ choice.0 }}" {% if form.price_range.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4">
                <label for="restaurant_types" class="block text-sm font-medium text-gray-700">ประเภทของร้านอาหาร</label>
                <!-- Add 'overflow-y-auto' and 'max-h-52' to make it scrollable with a height limit -->
                <div class="font-highlight w-full px-3 py-2 border border-gray-300 rounded-md overflow-y-auto max-h-52">
                    {% for choice in form.restaurant_types.field.queryset %}
                        <div class="mb-2">
                            <label>
                                <input type="checkbox" name="restaurant_types" value="{{ choice.pk }}" 
                                       {% if choice.pk in form.restaurant_types.value %}checked{% endif %}>
                                {{ choice }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            
            

            <!-- ปุ่มเพิ่มฟิลด์ใหม่ -->
            <label for="day_of_week" class="block text-sm font-medium my-3 text-gray-700">ช่วงเวลาเปิด-ปิด</label>
            <div id="operating-hours-container">
                <template id="operating-hour-template">
                    <div class="operating-hour flex space-x-4 mb-4">
                        <!-- วัน -->
                        <select name="day_of_week[]" class="w-1/4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
            
                        <!-- เวลาเปิด -->
                        <select name="opening_time[]" class="w-1/4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="00:00">00:00</option>
                            <option value="00:30">00:30</option>
                            <option value="01:00">01:00</option>
                            <option value="01:30">01:30</option>
                            <option value="02:00">02:00</option>
                            <option value="02:30">02:30</option>
                            <option value="03:00">03:00</option>
                        </select>
            
                        <!-- เวลาปิด -->
                        <select name="closing_time[]" class="w-1/4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="00:00">00:00</option>
                            <option value="00:30">00:30</option>
                            <option value="01:00">01:00</option>
                            <option value="01:30">01:30</option>
                            <option value="02:00">02:00</option>
                            <option value="02:30">02:30</option>
                            <option value="03:00">03:00</option>
                        </select>
            
                        <!-- ปุ่มลบ -->
                        <button type="button" class="remove-hour w-1/12 flex justify-center items-center px-1 py-1 text-red-500 hover:text-red-700 focus:outline-none">
                            <svg class="w-[24px] h-[24px] text-gray-800" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.1" d="m15 9-6 6m0-6 6 6m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                            </svg>
                        </button>
                    </div>
                </template>
            </div>
            
            <button type="button" id="add-operating-hour" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded my-4">
                เพิ่มช่วงเวลาเปิด-ปิด
            </button>
            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const addOperatingHourBtn = document.getElementById('add-operating-hour');
                    const container = document.getElementById('operating-hours-container');
                    const template = document.getElementById('operating-hour-template');

                    // Event listener to add new operating hour component
                    addOperatingHourBtn.addEventListener('click', function() {
                        const clone = template.content.cloneNode(true);  // Clone the template content
                        container.appendChild(clone);
                    });

                    // Remove operating hour row on clicking the remove button
                    container.addEventListener('click', function(event) {
                        if (event.target.closest('.remove-hour')) {
                            event.target.closest('.operating-hour').remove();
                        }
                    });
                });

            </script>
            
            

        </div>
        
    
    
        
        <h1 class="text-left text-sm font-bold mb-4 mt-9">ที่อยู่</h1>
        <div class="bg-white p-6 rounded shadow-md">
            <div class="mb-4">
                <label for="province" class="block text-sm font-medium text-gray-700">จังหวัด</label>
                <select required id="province" name="province" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">เลือกจังหวัด</option>
                    <!-- options will be dynamically populated by JS -->
                </select>
            </div>
            
            <div class="mb-4">
                <label for="district" class="block text-sm font-medium text-gray-700">เขต/อำเภอ</label>
                <select required id="district" name="district" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">เลือกเขต/อำเภอ</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label for="subdistrict" class="block text-sm font-medium text-gray-700">ตำบล</label>
                <select required id="subdistrict" name="subdistrict" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">เลือกตำบล</option>
                </select>
            </div>            

            <div id="map" class="pb-2" style="height: 200px; width: 100%;"></div>
            <!-- Hidden fields to store the latitude and longitude -->
            <input type="hidden" id="latitude" name="latitude" value="{{ form.latitude.value|default:'' }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ form.longitude.value|default:'' }}">


        </div>
    
        <button type="submit" class="bg-blue-500 hover:bg-blue-700 mb-4 mt-9 text-white font-bold py-2 px-14 rounded">
            บันทึก
        </button>
    </form>
        
</div>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        const provinceSelect = document.getElementById("province");
        const districtSelect = document.getElementById("district");
        const subdistrictSelect = document.getElementById("subdistrict");

        fetch("https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_province_with_amphure_tambon.json")
            .then(response => response.json())
            .then(data => {
                // เติมข้อมูลจังหวัดใน dropdown
                data.forEach(province => {
                    let option = new Option(province.name_th, province.id);
                    provinceSelect.add(option);
                });

                // เมื่อเลือกจังหวัด
                provinceSelect.addEventListener("change", function() {
                    let provinceId = this.value;
                    districtSelect.innerHTML = '<option value="">เลือกเขต/อำเภอ</option>'; // รีเซ็ตอำเภอ
                    subdistrictSelect.innerHTML = '<option value="">เลือกตำบล</option>'; // รีเซ็ตตำบล

                    let selectedProvince = data.find(province => province.id == provinceId);
                    if (selectedProvince && selectedProvince.amphure) {
                        selectedProvince.amphure.forEach(district => {
                            let option = new Option(district.name_th, district.id);
                            districtSelect.add(option);
                        });
                    }
                });

                // เมื่อเลือกอำเภอ
                districtSelect.addEventListener("change", function() {
                    let districtId = this.value;
                    subdistrictSelect.innerHTML = '<option value="">เลือกตำบล</option>'; // รีเซ็ตตำบล

                    let selectedProvince = data.find(province => province.id == provinceSelect.value);
                    if (selectedProvince) {
                        let selectedDistrict = selectedProvince.amphure.find(district => district.id == districtId);
                        if (selectedDistrict && selectedDistrict.tambon) {
                            selectedDistrict.tambon.forEach(subdistrict => {
                                let option = new Option(subdistrict.name_th, subdistrict.id);
                                subdistrictSelect.add(option);
                            });
                        }
                    }
                });
            })
            .catch(error => console.error("Error fetching data:", error));
    });
</script>

<!-- Add Google Maps JavaScript API -->
<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvte_IcXyAxq7Bwv_0MrmrmPaEwW89yFg&callback=initMap" async defer></script>

<script>
    let map;
    let marker;

    function initMap() {
        // ตั้งค่าตำแหน่งเริ่มต้น (กรุงเทพ)
        const initialLocation = { lat: 13.736717, lng: 100.523186 };

        // สร้างแผนที่
        map = new google.maps.Map(document.getElementById("map"), {
            center: initialLocation,
            zoom: 12,
        });

        // สร้าง Marker
        marker = new google.maps.Marker({
            map: map,
            position: initialLocation,
            draggable: true,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: "#FF0000",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#FFFFFF",
            }
        });

        // ฟังก์ชันเพื่ออัปเดตตำแหน่งของ Marker และเรียกใช้ Reverse Geocoding
        function updateLocation(position) {
            marker.setPosition(position);
            map.setCenter(position);
            document.getElementById("latitude").value = position.lat();
            document.getElementById("longitude").value = position.lng();
            geocodeLatLng(position);
        }

        // อัปเดตตำแหน่งเมื่อ Marker ถูกลาก
        google.maps.event.addListener(marker, 'dragend', function () {
            const position = marker.getPosition();
            updateLocation(position);
        });

        // อัปเดตตำแหน่งเมื่อคลิกที่แผนที่
        google.maps.event.addListener(map, 'click', function (event) {
            const position = event.latLng;
            updateLocation(position);
        });
    }

    // ใช้ Google Geocoder API เพื่อหาจังหวัด อำเภอ และตำบล
    function geocodeLatLng(position) {
        const geocoder = new google.maps.Geocoder();

        geocoder.geocode({ location: position }, (results, status) => {
            if (status === "OK") {
                if (results[0]) {
                    const components = results[0].address_components;
                    let province = "";
                    let district = "";
                    let subdistrict = "";

                    // วนลูปเพื่อหาจังหวัด อำเภอ ตำบลจากผลลัพธ์
                    components.forEach(component => {
                        if (component.types.includes("administrative_area_level_1")) {
                            province = component.long_name;
                        } else if (component.types.includes("administrative_area_level_2")) {
                            district = component.long_name;
                        } else if (component.types.includes("sublocality_level_1") || component.types.includes("administrative_area_level_3")) {
                            subdistrict = component.long_name;
                        }
                    });

                    // อัปเดตค่าใน select options โดยตรง
                    updateSelectOption("province", province);
                    updateSelectOption("district", district);
                    updateSelectOption("subdistrict", subdistrict);
                }
            } else {
                console.error("Geocode failed due to: " + status);
            }
        });
    }

    // ฟังก์ชันเพื่ออัปเดต dropdown
    function updateSelectOption(selectId, value) {
        const select = document.getElementById(selectId);
        const options = Array.from(select.options);
        const matchedOption = options.find(option => option.text.includes(value));

        if (matchedOption) {
            select.value = matchedOption.value;
        } else {
            // ถ้าไม่มีค่าที่ตรงกันใน dropdown, สามารถเพิ่มออปชันใหม่ได้ (หรือตั้งค่าให้เป็นค่าแรก)
            select.value = '';
        }
    }
</script> -->
{% endblock %}


